<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
	<title>春桃医生</title>
	<link rel="stylesheet" href="css/weui.min.css">
	<link rel="stylesheet" href="css/jquery-weui.css">
	<link rel="stylesheet" href="css/style.css">
	<script src="js/jquery-2.1.4.js"></script>
	<script src="js/jquery-weui.js"></script>
	<script src="js/md5.js"></script>
</head>
<style>
	.weui-cells:after{    border-bottom: 1px solid #979797;}
	input:-webkit-autofill {
		-webkit-box-shadow: 0 0 0px 1000px white inset !important;
	}
	.weui-flex{margin-bottom: 30px;}
	.weui-label{
		width: 55px;
	}
</style>
<body>
<div class="weui_de">
	<div class="content" id="docone">
		<div class="content_text">
			<img src="images/a_4.png" alt="" class="user_img">
			<h3 class="weui_wecliam">欢迎来到～春桃医生</h3>
			<p class="weui_d_fa">&nbsp;</p>
		</div>
		<div class="content_text">
			<div class="weui-cells weui-cells_form weui_margin_none">
				<div class="weui-cell weui_cell_pad">
					<div class="weui-cell__hd"><label class="weui-label weui-label_width">手机号</label></div>
					<div class="weui-cell__bd">
						<input class="weui-input" id="userAccount" name="userAccount" type="text" placeholder="请输入手机号码">
					</div>
				</div>
			</div>

			<div class="weui-cell weui-cell_vcode weui_cell_pad5">
				<div class="weui-cell__hd">
					<label class="weui-label weui-label_width">验证码</label>
				</div>
				<div class="weui-cell__bd">
					<input class="weui-input" id="smsCode" type="number" placeholder="请输入验证码">
				</div>
				<div class="weui-cell__ft">
					<button class="weui-vcode-btn" id="btnSendCode" onclick="sendMessage();">获取验证码</button>
				</div>
			</div>
		</div>
		<div class="content_text">
			<a href="javascript:;" class="weui-btn weui-btn_primary weui_btn_back" id="download">
				绑定微信
			</a>
		</div>
	</div>
</div>
	<div class="footh"></div>　　　　
	<div class="footer">
		<div class="tor-bottom">
            <img src="images/a_4.png"class="doaim" alt="">
			<span class="opdio">绑定微信后才能收到平台给您的付款金额</span>
		</div>
	</div>
	<div id="full" class='weui-popup__container'>
		<div class="weui-popup__overlay"></div>
		<div class="weui-popup__modal">
			<div class="weui-msg">
				<div class="weui-msg__icon-area">
					<img src="images/a_4.png" alt="" class="user_img">
				</div>
				<div class="weui-msg__text-area">
					<h2 class="weui-msg__title">操作成功</h2>
					<p class="weui-msg__desc">您已成功绑定微信，将会受到平台给您的付款金额</p>
				</div>

				<div class="weui-msg__extra-area">
					<div class="weui-footer">
						<p class="weui-footer__links">
							<a href="javascript:void(0);" class="weui-footer__link">春桃医生</a>
						<p class="weui-footer__text">您可关闭当前页</p>
						</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
    function sendMessage(){
        var userAccount = $("#userAccount").val().trim();
        var tell=/^1(3|4|5|7|8)\d{9}$/;
        if(!userAccount){
            $.alert("请输入手机号码");
            return false;
        }else if(!tell.test(userAccount)){
            $.alert("请输入正确的手机号码！");
            return false;
        }else {
            $.ajax({
                url: "/api/v1/public/callSMS",
                type: "post",
                data: {
                    'sendID': userAccount,
                    "msgType":"AUTH"
                },
                dataType: "json",
                success: function (obj) {
                    disabledVerifCode(60);
                    if (obj.message == "OK") {
                        disabledVerifCode(60);
                    } else {
                        $.alert(obj.message);
                    }
                },
                error: function (data) {
                    $.alert("验证码获取失败");
                }
            });
        }
    }

    function disabledVerifCode(second){
        second--;
        if(second){
            $("#btnSendCode").attr("disabled","disabled");
            $("#btnSendCode").html("重新获取("+second+"秒)");
            setTimeout("disabledVerifCode("+second+")", 1000);
        }else{
            $("#btnSendCode").removeAttr("disabled");
            $("#btnSendCode").html("重新获取");
        }
    }

$(function () {
	$("#electID").focus(function () {
		$(".footer").hide();
    })
    $("#electID").blur(function () {
        $(".footer").show();
    })
    $("#securityCode").focus(function () {
        $(".footer").hide();
    })
    $("#securityCode").blur(function () {
        $(".footer").show();
    })
	$("#download").click(function () {
        var getParam = function(name){
            var search = document.location.search;
            var pattern = new RegExp("[?&]"+name+"\=([^&]+)", "g");
            var matcher = pattern.exec(search);
            var items = null;
            if(null != matcher){
                try{
                    items = decodeURIComponent(decodeURIComponent(matcher[1]));
                }catch(e){
                    try{
                        items = decodeURIComponent(matcher[1]);
                    }catch(e){
                        items = matcher[1];
                    }
                }
            }
            return items;
        };
        var openid=getParam('openid');
        console.log(openid);

		var electID=$("#userAccount").val();
        var time=new Date();
        var userAccount=$("#userAccount").val();
        var smsCode=$("#smsCode").val();
        var currentTime=time.getTime();


        if(userAccount==""){
            $.alert("手机号码不能为空！");
            return false;
        }else  if(smsCode==""){
            $.alert("验证码不能为空！");
            return false;
        }else{
        $.showLoading("正在加载...");
			$.ajax({
				type: 'POST',
				url: '/api/v1/manage/oauth/accountbind',
				dataType: 'json',
				contentType: "application/json",
				data: JSON.stringify({
					"currentTime":currentTime,
					"openid":openid,
					"electID":electID,
					"securityCode":smsCode
				}),

				success: function (data) {
                    $.hideLoading();
					if(data.code=="OK"){
						$.hideLoading();
						$.toast("操作成功",1000);
						setTimeout(function () {
                            $("#full").popup();
                        },2000)
					}else{
                        $.hideLoading();
					    var data=data.message;
					    $.alert(data.message);
					}
				},
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    $.hideLoading();
					var message=XMLHttpRequest.responseJSON.message
                    html=message.substring(message.lastIndexOf(' '));
                    $.alert(html);
                }

			})
        }
    })
})




</script>

</html>